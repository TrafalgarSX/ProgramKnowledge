### 什么是VPN

![[Pasted image 20230220123555.png]]
OpenVPN 基于 OpenSSL 来实现安全，但是却不是传统意义上的 SSLVPN，**它只是一个普通的 VPN，工作在 IP 层而不是传输层。**

**VPN(Virtual Private Network) :虚拟专用网络**
VPN有哪些？  
* VPN协议有IPSec L2TP  PPTP   SSL
认证和加密的逻辑十分复杂和多样，不适合在IP层做，IP层做好快速路由和链接不同子网的功能就够了
我们可以让应用层或表示层或传输层来承载IP数据报，over模型的第三类，上层承载下层（虚拟网卡实现作为中转实现）
**SSLVPN:**
>IPSec 实现的 VPN 最后肯定不如**ip over ssl**好，因为扩充 IPSec 很难，毕竟它在协议栈中的位置不适合做大幅修改，但是 ssl 的扩展性却很好，它本身就在协议栈的顶端，即使影响也就影响应用层，比如迫使 http 转换到 https。

![[虚拟网卡和物理网卡#^42c345]]
![[虚拟网卡和物理网卡#^e58bde]]
![[虚拟网卡和物理网卡#^7b07e8]]
***总结：***
1.内核网络协议栈对数据进行一次封装之后，返回到虚拟网卡（用户空间）。
2.VPN用户程序读到虚拟网卡的数据(IP数据包)，对此数据用SSL协议进行封装（ip over ssl)。
3.最后再次通过虚拟网卡传输给内核网络协议栈，内核将其当作普通数据(ip over ssl)再次进行封装。
4.最后由物理网卡发送出去到外界网络上。


#### XX over YY的网络模型
分层模型的优势：每一层都仅仅承载数据而不管数据的格式和内容，上下层次间仅仅通过接口和服务来通信，**理论上任何层次的数据都可以被承载在其它的任何层次或者它当前的层次上**，于是就出现了很多 XX over YY 的网络模型，比较典型的比如 ppp over ethernet 等。
1.上层数据承载于下层，这实际上就是我们使用的普通的 TCP/IP 模型
2.同层承载，这一类构建方式主要是为了在一个以传输占主导的层次上增加一个非传输意义的逻辑或者说实现一个隧道
eg:
* pppoe 中，ethernet 主要用于局域网传输，而且性价比十分合理，但是却缺乏认证机制，但是 ppp 协议的认证功能虽然很好，但是却缺乏多点通信和寻址能力，作为传输协议意义不大，于是就使用 ethernet 进行传输，使用 ppp 进行认证
*  IPSec 的隧道模式，**它将一个 IP 数据报封装于另一个 IP 数据报中**，这样实际上也就实现了一般意义上的“虚拟局域网络”(注意不是vlan)，**因为在数据报到达最终目的地之前，参与路由的始终是外层的 IP 头，内层的 IP 头连同真实数据都被外层 IP 当成了 data，因此不参与路由**，所以从隧道的出发路由器到结束路由器，不管中间经过的是局域网，广域网还是别的什么，**内层的 IP 数据报一直“以为”自己在出发路由器的那个局域网内，因此就实现了一个虚拟网络**,实现了 VPN 中的 V。
>扩展
>IPSec 将 V 和 P 做到了一起，也就是说在实现 ip over ip 的过程中实现了**安全，这就是熟知的 ah 协议和 esp 协议**，实现了安全才能保证专用，否则别人都可以进入你的虚拟网络了，作为 VPN 来说，IPsec 就到此为止，但是 IPSec 的用处不光如此，IPSec 主要是保证 IP 数据报的安全(因为 IP 层不提供任何安全保护，ipv6 就不一样了，完全不需要 IPSec)，VPN 只是它的隧道模式的一个应用，除了隧道模式，IPSec 还有传输模式，不建立隧道，只是将认证或者加密的功能置于 IP 数据报中，当然也就是不需要 ip over ip了。
众所周知 IPSec 的隧道模式实现的 VPN 有一个缺陷，那就是很难穿越 nat，因为 nat 要修改 IP 头，一旦 IP 头被修改了，那么最终的 ah 或者 esp 的认证加密的校验结果就会出错，因此就不能随意在 nat 的网络环境中使用 IPSec 实现的 VPN

* 上层承载下层


#### VPN基本功能和应用场景
让外地员工访问到内网资源，利用VPN的解决方法就是在**内网中架设一台VPN服务器**。外地员工在当地连上互联网后，通过互联网连接VPN服务器，然后通过VPN服务器进入企业内网。**为了保证数据安全，VPN服务器和客户机之间的通讯数据都进行了加密处理。** 有了数据加密，就可以认为数据是在一条专用的数据链路上进行安全传输，就如同专门架设了一个专用网络一样，但实际上VPN使用的是互联网上的公用链路，因此VPN称为虚拟专用网络，**其实质上就是利用加密技术在公网上封装出一个数据通讯隧道。** 有了VPN技术，用户无论是在外地出差还是在家中办公，只要能上互联网就能利用VPN访问内网资源，这就是VPN在企业中应用得如此广泛的原因。


#### 参考
* *[VPN · GitBook](https://tonydeng.github.io/sdn-handbook/secure/vpn/)
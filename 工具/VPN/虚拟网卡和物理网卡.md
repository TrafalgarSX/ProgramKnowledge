### 物理网卡
#### 物理网卡收发数据的流程
* 收：外界向物理网卡发送数据时，外界发送到网卡的数据最终会传输到内核空间的网络协议栈中
* 发：本要从物理网卡发送数据时，数据从内核的网络协议栈传输到网卡，网卡负责将数据发送出去
* 网卡具有DMA能力，所以网卡和网络协议栈之间的数据传输由网卡负责，而非由内核亲自占用CPU来执行读和写

- 用户进程发送数据： 数据从用户空间——>内核的网络协议栈，再从网络协议栈-->网卡，最后发送到网络。
- 用户进程接收数据：网络--> 网卡-->内核的网络协议栈--> 用户空间--> 用户进程读取

**内核和用户空间的数据传输由内核占用cpu完成，内核和网卡之间的数据传输由DMA来完成。**
物理网卡需要通过网卡驱动在内核中注册后才能工作

### 虚拟网卡
* **虚拟网络接口**：又称虚拟网卡，使用网络底层编程技术实现的一个驱动软件。此类程序会在主机上增加一个非真实的网卡(TAP或TUN)。可以像其它网卡一样进行配置。服务程序可以在应用层打开虚拟网卡，**如果应用软件（如[网络浏览器](https://zh.wikipedia.org/wiki/%E7%BD%91%E7%BB%9C%E6%B5%8F%E8%A7%88%E5%99%A8 "网络浏览器")）向虚拟网卡发送数据，则服务程序可以读取到该数据。如果服务程序写合适的数据到虚拟网卡，应用软件也可以接收得到。**

内核可以直接创建虚拟的网卡，只要为虚拟网卡提供网卡驱动程序，使其可以在内核中注册成为网卡设备，就可以工作。

物理网卡的两端是:**外界网络和内核网络协议栈**
虚拟网卡的两端是：**内核网络协议栈和用户空间**，负责在内核网络协议栈和用户空间的程序之间传递数据
>1.发送到虚拟网卡的数据来自于用户空间，然后被内核读取到网络协议栈中。
>2.内核写入虚拟网卡准备通过该网卡发送的数据，目的地是用户空间。

虚拟网卡可以看作是用户空间的网卡，就像是用户空间的文件系统一样。
物理网卡以**比特流的方式传输数据**。
虚拟网卡不具备以比特流方式传输数据的硬件功能(字符设备)，所以，**绝不可能通过虚拟网卡向外界发送数据，外界数据也不可能直接发送到虚拟网卡上**。
* 能够直接收发外界数据的，只能是物理设备

虚拟网卡虽然不能将数据传输到外界网络，但是：
* **可以将数据传输到本机的另一个网卡上（虚拟网卡或者物理网卡）或者其他虚拟设备上（虚拟交换机）**
* **可以在用户空间运行一个可读写虚拟网卡的程序，该程序可将流经虚拟网卡的数据包进行处理**，这个用户程序就像是物理网卡的硬件功能一样，可以收发数据（物理网卡的硬件功能可以看所嵌入在网卡上的程序）OpenVPN就是这样的工具。

note: **用户空间的程序无法对数据包做任何封装和解封的操作，所有的封装和解封的操作只能由网络协议栈中完成。

![[Pasted image 20230226184311.png]]

**使用OpenVPN之所以可以对数据在封装一层隧道IP层，是因为OpenVPN可以读取已经封装过一次IP首部的数据**，并将包含ip首部的数据作为普通数据通过虚拟网卡再次传输给内核。 ^42c345

因为内核接受到的是来自虚拟网卡的数据，所以内核会把其当作普通数据从头开始封装（从传输层到链路层封装）。当数据从网络协议栈流出是，就有了两层IP首部的封装。 ^e58bde

数据  --> 内核空间 --> 用户空间  --> 内核空间   
------- 一次封装 ----------------- 二次封装 ^7b07e8

tcp/ip stack --> tun --> OpenVPN --> tcp/ip stack --> Phyical NIC

#### 虚拟网卡设备
tun tap是LINux提供的两种可收发数据的虚拟网卡设备

tun、tap 作为虚拟网卡，除了不具备物理网卡的硬件功能外，它们和物理网卡的功能是一样的，此外 tun、tap 负责在内核网络协议栈和用户空间之间传输数据。

tun 和 tap 都是虚拟网卡设备，但是：

* tun 是三层设备，其封装的外层是 IP 头
* tap 是二层设备，其封装的外层是以太网帧 (frame) 头
* tun 是 PPP 点对点设备，没有 MAC 地址
* tap 是以太网设备，有 MAC 地址
* tap 比 tun 更接近于物理网卡，可以认为，**tap 设备等价于去掉了硬件功能的物理网卡**

* 收发 tun 设备的用户程序，只能间接提供封装和解封数据包的 IP 头的功能
* 收发 tap 设备的用户程序，只能间接提供封装和解封数据包的帧头的功能

**tap 设备通常用来连接其它网络设备 (它更像网卡)，tun 设备通常用来结合用户空间程序实现再次封装。**
Eg:
tap 设备通常接入到虚拟交换机 (bridge) 上作为局域网的一个节点，tun 设备通常用来实现三层的 ip 隧道。

#### 创建并使用tun/tap设备
使用命令创建tun tap设备
```shell
openvpn --mktun

ip tuntap
tunct1
```

**写虚拟网卡的用户空间程序仅充当了一个特殊的【转发】程序：要么转发四层 tcp/udp 数据，要么转发三层数据包，要么转发二层数据帧。**




#### 参考
[理解Linux虚拟网卡设备tun/tap的一切 | 骏马金龙](https://www.junmajinlong.com/virtual/network/all_about_tun_tap/)
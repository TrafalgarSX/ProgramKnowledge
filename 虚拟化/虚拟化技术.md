### 虚拟化
--- 
虚拟化技术可将单台物理计算机作为多台计算机使用， 从而节省更多服务器和工作站的成本。

基本上每个计算机系统都提供一个给上层软件的界面，从处理器提供的基本指令集到很多中间件系统提供的巨大的应用程序界面集。**虚拟化本质上是扩展或替换一个现存界面来模仿另一个系统的行为。**

虚拟化优点：
- 可以在新的硬件和底层系统软件上运行旧有软件（旧有软件的维护跟不上硬件和底层系统软件的变化）。通过移植就有软件的底层接口到新平台，旧有软件就立刻可以在新平台上工作。
- 在服务器机器上安装虚拟机，能够最大化利用服务器的性能和资源。
- 云服务的提供被虚拟化技术直接驱动。
- 分布式应用的需求也激发虚拟化解决方案（动态地请求资源）
- 虚拟化可用于在一种物理体系结构上提供多种操作系统类型

💡在虚拟化中，物理资源通常有一个定语称为宿主(Host),而虚拟出来的资源通常由一个定语称为客户(Guest)

在计算机系统中，从底层至高层依次可分为：硬件层、操作系统层、函数库层、应用程序层，在对某层实施虚拟化时，该层和上一层之间的接口不发生变化，而之变化该层的实现方式。

#### 何为虚拟化
借助虚拟化技术，用户能以单个物理硬件系统为基础创建多个模拟环境或专用资源。

称为`Hypervisor`（虚拟机监控程序）的软件可直接连接到硬件，从而将一个系统划分为不同的、单独安全环境即虚拟机（MV）。虚拟机监控程序能够将计算机资源与硬件分离并适当分配资源。

配备了虚拟机监控程序的物理硬件叫做 **“主机”** ， 而使用其资源的虚拟机则被称为**虚拟客户机**。这些虚拟客户机将计算资源（如CPU、内存和存储器）是为一组可进行重新分配的资源。操作员可以控制CPU、内存、存储器和其他资源的虚拟实例，以便虚拟客户机能在需要时收到所需资源。

借助虚拟化资源，管理员能够对物理资源进行池化，从而真正发挥硬件的价值。

当虚拟环境正在运行时，如果用户或程序发出一条指令，请求来自物理环境的更多资源， 虚拟机监控程序就会将请求传递到物理系统并缓存更改，所有这些步骤都接近本机速度（特别是如果该请求来自基于 KVM，即[基于内核的虚拟机](https://www.redhat.com/zh/topics/virtualization/what-is-KVM)的开源虚拟机监控程序）。

#### 硬件抽象层上的虚拟化
虚拟机通过虚拟硬件抽象层来实现，又被称为指令集级虚拟化。

实现在此层的虚拟化技术可以对整个计算机系统进行虚拟，即可将一台物理计算机系统虚拟化为一台或多台虚拟计算机系统， 故又可称为系统级虚拟化。 每个虚拟计算机系统都拥有自己的虚拟硬件（CPU、内存和设备）。每个虚拟机的操作系统可以完全不同，执行环境是完全独立的。

虚拟机监视器（Virtual Machine Monitor， VMM）： 处理器虚拟化、内存虚拟化和I/O虚拟化。

##### 可虚拟化架构和不可虚拟化架构
在系统级虚拟化中，虚拟计算机系统和物理计算机系统可以是两个完全不同ISA（Instruction Set Architecture, 指令集架构）的系统，例如，可以在一个x86的物理计算机上运行一个安腾的虚拟计算机。但是，不同的ISA使得虚拟机的每一条指令都需要在物理机上模拟执行，从而造成性能上的极大下降。

相同体系结构的系统虚拟化通常会有比较好的性能，并且VMM实现起来也会比较简单。这种情况下虚拟机的大部分指令可以在处理器上直接运行，**只有那些与硬件资源关系密切的敏感指令才会由VMM进行处理。** 此时面前的一个问题是，**要能将这些敏感指令很好地筛选出来**。但事实上，某些处理器在设计之初并没有充分考虑虚拟化的需求，导致没有办法识别出所有的敏感指令，因而不具备**一个完备的可虚拟化结构。**

特权级（区分系统软件和应用软件）  
非最该特权级上运行  --> 特权指令引发一个异常 --> 处理器陷入最高特权级  --> 系统软件处理

**为了VMM可以完全控制系统资源，它不允许虚拟机上操作系统直接执行敏感指令。** 如果一个系统上所有敏感指令都是特权指令，则能够用一个很简单的方法来实现一个虚拟环境：将VMM运行在系统的最高特权级上，而将客户机操作系统运行在非最高特权级上，当客户机操作系统因执行敏感指令而陷入到VMM时，VMM模拟执行引起异常的敏感指令，这种方法被称为“陷入再模拟”。

在X86架构中，所有的特权指令都是敏感指令，但不是所有的敏感指令都是特权指令。

如果一个架构中所有的敏感指令都是特权指令，则称其为可虚拟化架构，否则为不可虚拟化架构。

##### 系统级别虚拟化的几种实现方案
1. 仿真(Emulation)
所有指令都采用模拟来实现:就是取一条指令，就模拟出这条指令执行的效果。

仿真是最复杂的虚拟化技术，这种方法不需要对宿主操作系统的特殊支持，虚拟机可以完全作为应用层程序运行。 使用仿真方法的主要问题就是速度会非常慢。 每条指令都必须在底层硬件上进行仿真，因此速度减慢100倍的情况也并不稀奇。

2. 完全虚拟化
在客户操作系统来看，完全虚拟化的虚拟平台和现在平台是一样的，客户机操作系统察觉不到是运行在一个虚拟平台上，这样的虚拟平台可以运行现有的操作系统，无需对操作系统进行任何修改。
   1. 软件实现的完全虚拟化
     > 在x86虚拟化技术的早期，没有在硬件层次上对虚拟化的支持，因此完全虚拟化只能通过软件实现。 典型的做法就是二进制代码翻译
     > 通过扫描并修改客户机的二进制代码，将难以虚拟化的指令转化为支持虚拟化的指令。VMM扫描发现需要处理的指令，就将其翻译成为支持虚拟化的指令块。这些指令块可以与VMM合作访问受限的虚拟资源。
   2. 硬件实现的完全虚拟化
    >硬件加入足够的虚拟化功能，可以截获操作系统对敏感指令的执行或者对敏感资源的访问，从而通过异常的方式报告给VMM，这样就解决了虚拟化问题。硬件虚拟化时一种完备的虚拟化方法，因而内存和外设的访问本身也是由指令来承载，对处理器指令级别的截获就意味着VMM可以模拟一个与真实主机完全一样的环境。
   3. 类虚拟化(Para-Virtualization)
    >这样的虚拟平台需要对所运行的客户机操作系统进行或多或少的修改使之适应虚拟环境，因此客户机操作系统知道其运行在虚拟平台上，并且会去主动适应。这种方式被称为类虚拟化，有时也称作半虚拟化。另外，值得指出的是，一个VMM可以既提供完全虚拟化的虚拟平台，又提供类虚拟化的虚拟平台。

##### Hypervisor模型
在Hypervisor模型中，**VMM首先可以被看做是一个完备的操作系统**，不过和传统操作系统不同的是，VMM是为虚拟化而设计的，因此还具备虚拟化功能。从架构上来看，首先，所有的物理资源如处理器、内存和I/O设备等都归VMM所有，因此，VMM承担着管理物理资源的责任；其次，VMM需要向上提供虚拟机用于运行客户机操作系统，因此，VMM还负责虚拟环境的创建和管理。

##### 宿主模型
与Hypervisor模型不同。在宿主模型中，**物理资源由宿主机操作系统管理**。宿主机操作系统是传统操作系统，如Windows 、Linux等，这些传统操作系统并不是为虚拟化而设计的，因此本身并不具备虚拟化功能，**实际的虚拟化功能由VMM来提供。VMM通常是宿主机操作系统独立的内核模块**，有些实现中还包括用户态进程，如负责I/O虚拟化的用户态设备模型。 VMM通过调用宿主机操作系统的服务来获得资源， 实现处理器、内存和I/O设备的虚拟化。VMM创建出虚拟机之后，通常将虚拟机作为宿主机操作系统的一个进程参与调度。

#### 操作系统虚拟化
操作系统虚拟化在内核中进行，内核则是操作系统的中央任务管理器。操作系统的内核可以提供多个互相隔离的用户态实例。这些用户态实例（通常称为容器）对于它的用户来说就像是一台真实的计算机，有自己独立的文件系统，网络，系统设置和库函数。（不虚拟任何硬件设备）

👉由于这是操作系统内核主动提供的虚拟化，因此操作系统层上的虚拟化通常非常高效，它的虚拟化资源和性能开销非常小，也不需要有硬件的特殊支持。 但是每个容器中的操作系统通常必须是同一种操作系统。

#### 库函数层上的虚拟化
Wine 就是在Linux上模拟了Windows的库函数接口， 使得一个Windows应用程序能够在 Linux上正常运行。

#### 虚拟化和云计算的区别
两者的核心理念都是从硬件中分离资源，以创建可用的环境，所以很容易被混为一谈。虚拟化有助于创建云，但它并非实现云计算的决定性技术。
- 虚拟化是一种将功能与硬件分离的技术
- 云计算并不仅仅是以来于这种分离的解决方案

#### Virtualiza
##### Hypervisor
- Type 1  /BM
>Type 1 is a hypervisor that is installed directly on top of the physical server. They also called bare meatal hypervisors

>secure   lower the latency   these are the ones that you'll see in the market the most

>Examples: VMware ESXi, Miscrosoft Hyper-V   open source KVM

- Type 2
>what makes these different is that there is a layer of host OS that sits between the physical server and hypervisor

>These are a lot less frequent. They're mostly used for end-user virtualization and you might see some of the market that are called  Oracle, VirtualBox, or VMware Workstation. higher latency

![[Virtualization]]


A VM is simply a software-based computer. They have an operating system and applications, and they're **completely independent** of one another. But, you can run multiple of them on a hypervisor. And **the hypervisor manages the resources that are allocated to these virtual environments from the physical server.**

Benefits:
- cost savings
- agility tspeed
- lower downtime

[虚拟化技术的分类及介绍 - 知乎](https://zhuanlan.zhihu.com/p/102809005)
[通俗易懂，一文带你了解什么是虚拟化技术（Virtualization）？](https://www.redhat.com/zh/topics/virtualization)
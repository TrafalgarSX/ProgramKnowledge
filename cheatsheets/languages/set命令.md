### set命令
set命令用来修改 Shell 环境的运行参数，也就是可以定制环境。一共有十几个参数可以定制，官方手册有完整清单，本文介绍其中最常用的四个。

如果命令行下不带任何参数，直接运行`set`，会显示所有的环境变量和 Shell 函数。

#### set -u
执行脚本的时候，如果**遇到不存在的变量，Bash 默认忽略它。**

大多数情况下，这不是开发者想要的行为，遇到变量不存在，脚本应该报错，而不是一声不响地往下执行。

`set -u`就用来改变这种行为。脚本在头部加上它，遇到不存在的变量就会报错，并停止执行。
```bash
 #!/usr/bin/env bash
 set -u
 
 echo $a
 echo bar
```

运行结果如下。

```bash
 
 $ bash script.sh
 bash: script.sh:行4: a: 未绑定的变量
```

`-u`还有另一种写法`-o nounset`，两者是等价的。
```bash
set -o nounset
```

#### set -x
默认情况下，脚本执行后，屏幕只显示运行结果，没有其他内容。如果多个命令连续执行，它们的运行结果就会连续输出。有时会分不清，某一段内容是什么命令产生的。

`set -x`用来在运行结果之前，先输出执行的那一行命令。

执行命令之前，该命令会先打印出来，行首以`+`表示。这对于调试复杂的脚本是很有用的。
`-x`还有另一种写法`-o xtrace`。

 ```bash
 set -o xtrace
 ```

#### Bash 的错误处理
如果脚本里面有运行失败的命令（返回值非0），Bash 默认会继续执行后面的命令。

Bash 只是显示有错误，并没有终止执行。

这种行为很不利于脚本安全和除错。实际开发中，如果某个命令失败，往往需要脚本停止执行，防止错误累积。这时，一般采用下面的写法。

```bash
 
 command || exit 1
```

上面的写法表示只要`command`有非零返回值，脚本就会停止执行。

如果停止执行之前需要完成多个操作，就要采用下面三种写法。

 ```bash
 
 # 写法一
 command || { echo "command failed"; exit 1; }
 
 # 写法二
 if ! command; then echo "command failed"; exit 1; fi
 
 # 写法三
 command
 if [ "$?" -ne 0 ]; then echo "command failed"; exit 1; fi
 ```

#### set -e
上面这些写法多少有些麻烦，容易疏忽。`set -e`从根本上解决了这个问题，它使得脚本只要发生错误，就终止执行。

`set -e`根据返回值来判断，一个命令是否运行失败。但是，某些命令的非零返回值可能不表示失败，或者开发者希望在命令失败的情况下，脚本继续执行下去。这时可以暂时关闭`set -e`，该命令执行结束后，再重新打开`set -e`。

`set +e`表示关闭`-e`选项，`set -e`表示重新打开`-e`选项。

还有一种方法是使用`command || true`，使得该命令即使执行失败，脚本也不会终止执行。

`-e`还有另一种写法`-o errexit`。

```bash
 
 set -o errexit
```

#### set -o pipefail
`set -e`有一个例外情况，就是不适用于管道命令。

所谓管道命令，就是多个子命令通过管道运算符（`|`）组合成为一个大的命令。Bash 会把最后一个子命令的返回值，作为整个命令的返回值。也就是说，只要最后一个子命令不失败，管道命令总是会执行成功，因此它后面命令依然会执行，`set -e`就失效了。

#### set --
`set -- "${parm}"` 是一个 bash 脚本命令，它的作用是将变量 `${parm}` 的值作为参数传递给 `set` 命令，并将参数列表设置为 `${parm}` 的值。

`set -- "${parm}"` 的作用是将 `${parm}` 的值设置为 shell 的位置参数（即 `$1`, `$2`, `$3` 等），并将 `$0`（即脚本名称）保持不变。`${parm}` 的值将被解析为一个字符串，如果这个字符串包含空格或其他特殊字符，可以使用双引号将其括起来。

这个命令通常用于将一个变量作为参数传递给一个函数或另一个脚本。例如，假设有一个脚本 `myscript.sh`，它需要一个参数来执行某些操作。可以使用 `set -- "${parm}"` 命令将 `${parm}` 的值设置为脚本的位置参数，然后在 `myscript.sh` 中使用 `$1` 来引用这个参数。例如：

```
#!/bin/bash

# 将参数传递给 myfunction 函数
myfunction() {
  echo "参数为：$1"
}

# 设置位置参数为 ${parm} 的值
set -- "${parm}"

# 调用 myfunction 函数，并传递参数
myfunction "$1"
```

在这个例子中，`${parm}` 的值被设置为位置参数 `$1`，然后传递给 `myfunction` 函数。函数将打印参数的值。

#### 总结
`set`命令的上面这四个参数，一般都放在一起使用。

 ```bash
 
 # 写法一
 set -euxo pipefail
 
 # 写法二
 set -eux
 set -o pipefail
 ```

这两种写法建议放在所有 Bash 脚本的头部。

另一种办法是在执行 Bash 脚本的时候，从命令行传入这些参数。

```bash
 
 $ bash -euxo pipefail script.sh
```

[Bash 脚本 set 命令教程 - 阮一峰的网络日志](https://www.ruanyifeng.com/blog/2017/11/bash-set.html)

### 二维码
---
二维码（Quick Response Code）是一种二维条形码，由日本的Denso Wave公司于1994年开发。二维码可以存储大量的信息，包括文本、网址、电话号码等。

QR码呈正方形，常见的是黑白两色。在3个角落，印有较小，像“回”字的正方图案。这3个是帮助解码软件定位的图案，用户不需要对准，无论以任何角度扫描，资料仍然可以正确读取

#### 结构
QR码最大特征为其左上，右上，左下三个大型的如同“回”字的黑白间同心方图案，为QR码识别定位标记，失去其中一个会影响识别。而呈棋盘般分布的有别于大定位标记的较小的同心方则为其校正标记，用于校正识别，版本1没有校正标记，版本2在右下方，其中心点在左下和右上定位标记的外边框的相交点，版本10开始以每个等距的方式出现在右下校正点至左下和右上定位标记的外边框的连线、左上与左下定位标记的外边框的连线、左上与右上定位标记的外边框的连线之间、这四边线上等距点对边相连线，版本10等距有1个，版本25为3个，版本40为5个。

QR码一共提供40种不同版本存储密度的结构，对应指示图的“版本信息”，版本1为21×21模块（模块为QR码中的最小单元），每增加一个版本，长宽各增加4个模块，最大的版本40为177×177模块。

|QR码最大资料容量（对于版本40）|   |
|---|---|
|[数字](https://zh.wikipedia.org/wiki/%E6%95%B8%E5%AD%97 "数字")|最多7,089字符|
|[字母](https://zh.wikipedia.org/wiki/%E5%AD%97%E6%AF%8D "字母")|最多4,296字符|
|[二进制数](https://zh.wikipedia.org/wiki/%E4%BA%8C%E9%80%B2%E4%BD%8D%E6%95%B8 "二进制数")（8 bit）|最多2,953 [字节](https://zh.wikipedia.org/wiki/%E4%BD%8D%E5%85%83%E7%BB%84 "比特组")|
|日文[汉字](https://zh.wikipedia.org/wiki/%E6%BC%A2%E5%AD%97 "汉字")／[片假名](https://zh.wikipedia.org/wiki/%E7%89%87%E5%81%87%E5%90%8D "片假名")|最多1,817字符（采用[Shift JIS](https://zh.wikipedia.org/wiki/Shift_JIS "Shift JIS")）|
|中文[汉字](https://zh.wikipedia.org/wiki/%E6%BC%A2%E5%AD%97 "汉字")|最多984字符（采用[UTF-8](https://zh.wikipedia.org/wiki/UTF-8 "UTF-8")）|
|最多1,800字符（采用[BIG5](https://zh.wikipedia.org/wiki/BIG5 "BIG5")/[GB2312](https://zh.wikipedia.org/wiki/GB2312 "GB2312")）|

#### 容错能力
QR码有容错能力，即使图形破损仍然可以读取，破损面积最高可达30%。因此QR码也广泛使用在运输外箱上。

相对而言，QR码图形面积愈大，容错率愈高，所以一般折衷使用15%容错能力（M等级）。

|错误修正容量|   |
|---|---|
|L等级|可修正7%的字码|
|M等级|可修正15%的字码|
|Q等级|可修正25%的字码|
|H等级|可修正30%的字码|

#### 编码
QR码的格式信息记录了两种数据：**纠错等级和掩码的类型**。

**掩码**的作用是为了对数据区域进行掩模以利于扫描仪识别，可以避免数据区域出现连续的空白或者连续的黑色区，同时也避免了数据区出现类似定位点样式的正方形出现。掩模图案在整个数据区域的网格内不断重复进行掩模计算（功能图形不掩模），数据区上对应掩模黑色模块的单元将会反转。每个二维码上会有两组相同的格式信息出现，并且带有BCH纠错。

二维码的掩模是用来改变二维码模块（像素）的颜色的模式。掩模的目的是为了提高二维码的可读性和可靠性。根据二维码的标准，有8种不同的掩模，编号为0到7。每种掩模都有一个对应的规则，规则是基于模块的行号和列号的函数。以下是8种掩模的规则：

1. 掩模0：(row + column) % 2 == 0
2. 掩模1：row % 2 == 0
3. 掩模2：column % 3 == 0
4. 掩模3：(row + column) % 3 == 0
5. 掩模4：(floor(row / 2) + floor(column / 3)) % 2 == 0
6. 掩模5：((row * column) % 2) + ((row * column) % 3) == 0
7. 掩模6：(((row * column) % 2) + ((row * column) % 3)) % 2 == 0
8. 掩模7：(((row + column) % 2) + ((row * column) % 3)) % 2 == 0

在生成二维码时，会尝试所有的掩模，并选择使得二维码的可读性最高的掩模。可读性是通过一个特定的评价函数来计算的，这个函数考虑了二维码的几个特性，例如模块的颜色分布和连续的模块的数量。

#### 生成步骤
二维码的生成过程包括以下几个步骤：

1. 数据编码：将输入的数据（例如文本或网址）转换为二进制数据。二维码支持多种数据类型，包括数字、字母、字节和日本的Kanji字符。
    
2. 纠错编码：为二进制数据添加纠错码。纠错码可以在二维码被部分损坏或遮挡的情况下恢复原始数据。二维码有四个纠错等级，从低到高分别为L（7%的数据可以被恢复）、M（15%的数据可以被恢复）、Q（25%的数据可以被恢复）和H（30%的数据可以被恢复）。
    
3. 结构编码：将二进制数据和纠错码组合成一个数据字符串，然后添加必要的格式和版本信息。
    
4. 模块放置：将数据字符串转换为一个二维的模块矩阵。每个模块对应一个像素，可以是黑色（表示1）或白色（表示0）。
    
5. 掩模：为了提高二维码的可读性，会尝试多种不同的模式（称为掩模）来调整模块的颜色。选择使得二维码的可读性最高的掩模。
    
6. 输出：将模块矩阵输出为一个图像文件，例如PNG或JPEG。
    

这就是二维码的基本原理。在实际应用中，二维码的生成和读取都需要复杂的算法，但这些算法都基于上述的步骤。


### 参考
生成二维码的开源 cpp 代码
[QrCodeGeneratorDemo.cpp](https://github.com/nayuki/QR-Code-generator/blob/master/cpp/QrCodeGeneratorDemo.cpp)
### auto & decltype

å…³äºC++11æ–°ç‰¹æ€§ï¼Œæœ€å…ˆæåˆ°çš„è‚¯å®šæ˜¯ç±»å‹æ¨å¯¼ï¼ŒC++11å¼•å…¥äº†autoå’Œdecltypeå…³é”®å­—ï¼Œä½¿ç”¨ä»–ä»¬å¯ä»¥åœ¨ç¼–è¯‘æœŸå°±æ¨å¯¼å‡ºå˜é‡æˆ–è€…è¡¨è¾¾å¼çš„ç±»å‹ï¼Œæ–¹ä¾¿å¼€å‘è€…ç¼–ç ä¹Ÿç®€åŒ–äº†ä»£ç ã€‚

#### auto

autoå¯ä»¥è®©ç¼–è¯‘å™¨åœ¨ç¼–è¯‘å™¨å°±æ¨å¯¼å‡ºå˜é‡çš„ç±»å‹ï¼Œè¯ä¸å¤šè¯´ä¸Šä»£ç ï¼š

```text
auto a = 10; // 10æ˜¯intå‹ï¼Œå¯ä»¥è‡ªåŠ¨æ¨å¯¼å‡ºaæ˜¯int

int i = 10;
auto b = i; // bæ˜¯intå‹

auto d = 2.0; // dæ˜¯doubleå‹
```

è¿™å°±æ˜¯autoçš„åŸºæœ¬ç”¨æ³•ï¼Œå¯ä»¥é€šè¿‡=å³è¾¹çš„ç±»å‹æ¨å¯¼å‡ºå˜é‡çš„ç±»å‹ã€‚

autoæ¨å¯¼è§„åˆ™

ç›´æ¥çœ‹ä»£ç 

ä»£ç 1ï¼š

```text
int i = 10;
auto a = i, &b = i, *c = &i; // aæ˜¯intï¼Œbæ˜¯içš„å¼•ç”¨ï¼Œcæ˜¯içš„æŒ‡é’ˆï¼Œautoå°±ç›¸å½“äºint
auto d = 0, f = 1.0; // errorï¼Œ0å’Œ1.0ç±»å‹ä¸åŒï¼Œå¯¹äºç¼–è¯‘å™¨æœ‰äºŒä¹‰æ€§ï¼Œæ²¡æ³•æ¨å¯¼
auto e; // errorï¼Œä½¿ç”¨autoå¿…é¡»é©¬ä¸Šåˆå§‹åŒ–ï¼Œå¦åˆ™æ— æ³•æ¨å¯¼ç±»å‹
```

ä»£ç 2ï¼š

```text
void func(auto value) {} // errorï¼Œautoä¸èƒ½ç”¨ä½œå‡½æ•°å‚æ•°

class A {
    auto a = 1; // errorï¼Œåœ¨ç±»ä¸­autoä¸èƒ½ç”¨ä½œéé™æ€æˆå‘˜å˜é‡
    static auto b = 1; // errorï¼Œè¿™é‡Œä¸autoæ— å…³ï¼Œæ­£å¸¸static int b = 1ä¹Ÿä¸å¯ä»¥
    static const auto c = 1; // ok
};

void func2() {
    int a[10] = {0};
    auto b = a; // ok
    auto c[10] = a; // errorï¼Œautoä¸èƒ½å®šä¹‰æ•°ç»„ï¼Œå¯ä»¥å®šä¹‰æŒ‡é’ˆ
    vector<int> d;
    vector<auto> f = d; // errorï¼Œautoæ— æ³•æ¨å¯¼å‡ºæ¨¡æ¿å‚æ•°
}
```

æ€»ç»“ä¸€ä¸‹autoçš„é™åˆ¶ï¼š

- autoçš„ä½¿ç”¨**å¿…é¡»é©¬ä¸Šåˆå§‹åŒ–ï¼Œå¦åˆ™æ— æ³•æ¨å¯¼å‡ºç±»å‹**ã€‚ 
  
- autoåœ¨ä¸€è¡Œå®šä¹‰å¤šä¸ªå˜é‡æ—¶ï¼Œå„ä¸ªå˜é‡çš„æ¨å¯¼**ä¸èƒ½äº§ç”ŸäºŒä¹‰æ€§**ï¼Œå¦åˆ™ç¼–è¯‘å¤±è´¥

- auto**ä¸èƒ½ç”¨ä½œå‡½æ•°å‚æ•°**
  
- åœ¨ç±»ä¸­autoä¸èƒ½ç”¨ä½œéé™æ€æˆå‘˜å˜é‡(å¯ä»¥ä½œä¸ºé™æ€å¸¸é‡  static const)

- auto**ä¸èƒ½å®šä¹‰æ•°ç»„ï¼Œå¯ä»¥å®šä¹‰æŒ‡é’ˆ**
  
- auto**æ— æ³•æ¨å¯¼å‡ºæ¨¡æ¿å‚æ•°**

å†çœ‹è¿™æ®µä»£ç ï¼š

```text
int i = 0;
auto *a = &i; // aæ˜¯int*
auto &b = i; // bæ˜¯int&
auto c = b; // cæ˜¯intï¼Œå¿½ç•¥äº†å¼•ç”¨

const auto d = i; // dæ˜¯const int
auto e = d; // eæ˜¯int

const auto& f = e; // fæ˜¯const int&
auto &g = f; // gæ˜¯const int&
```

é¦–å…ˆä»‹ç»ä¸‹cvæ˜¯æŒ‡const å’Œvolatile

- åœ¨**ä¸å£°æ˜ä¸ºå¼•ç”¨æˆ–æŒ‡é’ˆ**æ—¶ï¼Œautoä¼šå¿½ç•¥ç­‰å·å³è¾¹çš„å¼•ç”¨ç±»å‹å’Œcvé™å®š
  
- åœ¨**å£°æ˜ä¸ºå¼•ç”¨æˆ–è€…æŒ‡é’ˆ**æ—¶ï¼Œautoä¼šä¿ç•™ç­‰å·å³è¾¹çš„å¼•ç”¨å’Œcvå±æ€§

ä»€ä¹ˆæ—¶å€™ä½¿ç”¨auto

è¿™é‡Œæ²¡æœ‰ç»å¯¹ç­”æ¡ˆï¼Œåªèƒ½è¯´ä¸€ä¸‹æˆ‘è‡ªå·±çš„ç†è§£ï¼Œä¸ªäººè®¤ä¸ºåœ¨ä¸å½±å“ä»£ç ä»£ç å¯è¯»æ€§çš„å‰æä¸‹å°½å¯èƒ½ä½¿ç”¨autoæ˜¯è›®å¥½çš„ï¼Œå¤æ‚ç±»å‹å°±ä½¿ç”¨autoï¼Œintã€doubleè¿™ç§å°±æ²¡æœ‰å¿…è¦ä½¿ç”¨autoäº†å§ï¼Œçœ‹ä¸‹é¢è¿™æ®µä»£ç ï¼š

```text
auto func = [&] {
        cout << "xxx";
}; // å¯¹äºfuncä½ éš¾é“ä¸ä½¿ç”¨autoå—ï¼Œåæ­£æˆ‘æ˜¯ä¸å…³å¿ƒlambdaè¡¨è¾¾å¼ç©¶ç«Ÿæ˜¯ä»€ä¹ˆç±»å‹ã€‚

auto asyncfunc = std::async(std::launch::async, func);
// å¯¹äºasyncfuncä½ éš¾é“ä¸ä½¿ç”¨autoå—ï¼Œæˆ‘æ˜¯æ‡’å¾—å†™std::futurexxxç­‰ä»£ç ï¼Œè€Œä¸”æˆ‘ä¹Ÿè®°ä¸ä½å®ƒè¿”å›çš„ç©¶ç«Ÿæ˜¯ä»€ä¹ˆ...
```

#### decltype

ä¸Šé¢ä»‹ç»autoç”¨äºæ¨å¯¼å˜é‡ç±»å‹ï¼Œè€Œ**decltypeåˆ™ç”¨äºæ¨å¯¼è¡¨è¾¾å¼ç±»å‹**ï¼Œè¿™é‡Œåªç”¨äºç¼–è¯‘å™¨åˆ†æè¡¨è¾¾å¼çš„ç±»å‹ï¼Œ**è¡¨è¾¾å¼å®é™…ä¸ä¼šè¿›è¡Œè¿ç®—**ï¼Œä¸Šä»£ç ï¼š

```text
int func() { return 0; }
decltype(func()) i; // iä¸ºintç±»å‹

int x = 0;
decltype(x) y; // yæ˜¯intç±»å‹
decltype(x + y) z; // zæ˜¯intç±»å‹
```

ğŸ’¡æ³¨æ„ï¼šdecltypeä¸ä¼šåƒautoä¸€æ ·å¿½ç•¥å¼•ç”¨å’Œcvå±æ€§ï¼Œ**decltypeä¼šä¿ç•™è¡¨è¾¾å¼çš„å¼•ç”¨å’Œcvå±æ€§**

```cpp
const int &i = 1;
int a = 2;
decltype(i) b = 2; // bæ˜¯const int&
```

decltypeæ¨å¯¼è§„åˆ™

å¯¹äºdecltype(exp)æœ‰

- expæ˜¯è¡¨è¾¾å¼ï¼Œdecltype(exp)å’Œexpç±»å‹ç›¸åŒ  **?? è¿™å¥å¹¶ä¸å‡†ç¡®, è¦åŒºåˆ† å·¦å€¼è¡¨è¾¾å¼ï¼ˆå†…éƒ¨è¿˜æœ‰åŒºåˆ†ï¼Œ æ¯”å¦‚ id-expressioni å’Œ (id-expression) ï¼‰è¿˜æ˜¯å³å€¼è¡¨è¾¾å¼**
  
- expæ˜¯å‡½æ•°è°ƒç”¨ï¼Œdecltype(exp)å’Œå‡½æ•°è¿”å›å€¼ç±»å‹ç›¸åŒ

```cpp
int a = 0, b = 0;
decltype(a + b) c = 0; // cæ˜¯intï¼Œå› ä¸º(a+b)è¿”å›ä¸€ä¸ªå³å€¼
decltype(a += b) d = c;// dæ˜¯int&ï¼Œå› ä¸º(a+=b)è¿”å›ä¸€ä¸ªå·¦å€¼

d = 20;
cout << "c " << c << endl; // è¾“å‡ºc 20
```

decltypeå…³é”®å­—ç”¨äºæ£€æŸ¥è¡¨è¾¾å¼çš„ç±»å‹ã€‚å½“è¡¨è¾¾å¼æ˜¯ä¸€ä¸ªå·¦å€¼æ—¶ï¼Œdecltypeä¼šæ¨å¯¼å‡ºå·¦å€¼å¼•ç”¨ç±»å‹ã€‚

ä»¥ä¸‹æ˜¯ä¸€äº›ä¾‹å­ï¼š

* å½“è¡¨è¾¾å¼æ˜¯ä¸€ä¸ªæœªè¢«æ‹¬å·åŒ…å›´çš„æ ‡è¯†ç¬¦æˆ–ç±»æˆå‘˜è®¿é—®è¡¨è¾¾å¼æ—¶ï¼Œdecltypeä¼šæ¨å¯¼å‡ºè¯¥æ ‡è¯†ç¬¦æˆ–æˆå‘˜çš„ç±»å‹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœxæ˜¯ä¸€ä¸ªintç±»å‹çš„å˜é‡ï¼Œé‚£ä¹ˆdecltype(x)çš„ç»“æœå°±æ˜¯intã€‚

* å½“è¡¨è¾¾å¼æ˜¯ä¸€ä¸ªå·¦å€¼ï¼Œä½†ä¸æ˜¯ä¸Šè¿°æƒ…å†µæ—¶ï¼Œdecltypeä¼šæ¨å¯¼å‡ºå·¦å€¼å¼•ç”¨ç±»å‹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœxæ˜¯ä¸€ä¸ªintç±»å‹çš„å˜é‡ï¼Œé‚£ä¹ˆdecltype((x))çš„ç»“æœå°±æ˜¯int&ã€‚

* å½“è¡¨è¾¾å¼æ˜¯ä¸€ä¸ªå³å€¼æ—¶ï¼Œdecltypeä¼šæ¨å¯¼å‡ºè¯¥å³å€¼çš„ç±»å‹ã€‚ä¾‹å¦‚ï¼Œdecltype(42)çš„ç»“æœå°±æ˜¯intã€‚

```cpp

class Test{
public:
	int a;

};

    // decltype rvalue result is rvalue's type
    decltype(func()) t = func();  // Test

    decltype((func())) t2 = func();  // Test

    // decltype xvalue result is rvalue reference
    decltype(static_cast<Test&&>(t)) t3 = static_cast<Test&&>(t);  // Test&&

    Test tt;
    decltype((tt)) t4 = t; // Test&
    decltype(t) t5 = t;    // Test

    decltype(t.a) k = 0;   // int
    decltype((t.a)) kk = k; // int&

    // decltype lvalue result is lvalue reference ?  not really
    int a = 0,b = 0;
    // a+= 1 is lvalue
    decltype(a+=1) o = b;  // int&
    // a also is lvalue
    decltype(a) x = b;  // int
    decltype((a)) y = b; // int&
```

#### autoå’Œdecltypeçš„é…åˆä½¿ç”¨

autoå’Œdecltypeä¸€èˆ¬é…åˆä½¿ç”¨åœ¨æ¨å¯¼å‡½æ•°è¿”å›å€¼çš„ç±»å‹é—®é¢˜ä¸Šã€‚

ä¸‹é¢è¿™æ®µä»£ç 

```text
template<typename T, typename U>
return_value add(T t, U u) { // tå’Œvç±»å‹ä¸ç¡®å®šï¼Œæ— æ³•æ¨å¯¼å‡ºreturn_valueç±»å‹
    return t + u;
}
```

ä¸Šé¢ä»£ç ç”±äºtå’Œuç±»å‹ä¸ç¡®å®šï¼Œé‚£å¦‚ä½•æ¨å¯¼å‡ºè¿”å›å€¼ç±»å‹å‘¢ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæƒ³åˆ°è¿™ç§

```text
template<typename T, typename U>
decltype(t + u) add(T t, U u) { // tå’Œuå°šæœªå®šä¹‰
    return t + u;
}
```

ğŸ’¡è¿™æ®µä»£ç åœ¨C++11ä¸Šæ˜¯ç¼–è¯‘ä¸è¿‡çš„ï¼Œå› ä¸ºåœ¨decltype(t +u)æ¨å¯¼æ—¶ï¼Œtå’Œuå°šæœªå®šä¹‰ï¼Œå°±ä¼šç¼–è¯‘å‡ºé”™ï¼Œæ‰€ä»¥æœ‰äº†ä¸‹é¢çš„å«åšè¿”å›ç±»å‹åç½®çš„é…åˆä½¿ç”¨æ–¹æ³•ï¼š

```text
template<typename T, typename U>
auto add(T t, U u) -> decltype(t + u) {
    return t + u;
}
```

è¿”å›å€¼åç½®ç±»å‹è¯­æ³•å°±æ˜¯ä¸ºäº†è§£å†³å‡½æ•°è¿”å›åˆ¶ç±»å‹ä¾èµ–äºå‚æ•°ä½†å´éš¾ä»¥ç¡®å®šè¿”å›å€¼ç±»å‹çš„é—®é¢˜ã€‚


[C++11çš„ç±»å‹æ¨å¯¼è¯¦è§£ - çŸ¥ä¹](https://zhuanlan.zhihu.com/p/137662774)
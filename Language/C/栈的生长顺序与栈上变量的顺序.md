### æ ˆçš„ç”Ÿé•¿é¡ºåº
---
æˆ‘ä»¬éƒ½çŸ¥é“ Linux ä¸Šæ ˆçš„ç”Ÿé•¿é¡ºåºæ˜¯ä»é«˜åœ°å€åˆ°ä½åœ°å€ã€‚

å®é™…ä¸Š**è¿›ç¨‹åœ°å€ç©ºé—´çš„åˆ†å¸ƒå–å†³äºæ“ä½œç³»ç»Ÿï¼Œæ ˆå‘ä»€ä¹ˆæ–¹å‘å¢é•¿å–å†³äºæ“ä½œç³»ç»Ÿä¸CPUçš„ç»„åˆã€‚**

ç»è¿‡æµ‹è¯•ï¼ŒWindows ä¸Šçš„æ ˆçš„ç”Ÿé•¿é¡ºåºä¹Ÿæ˜¯ä»é«˜åœ°å€åˆ°ä½åœ°å€ã€‚

åº”è¯¥æ˜¯ç”±äº x86ç¡¬ä»¶çš„æƒ…å†µ

ğŸ‘‰x86ç¡¬ä»¶ç›´æ¥æ”¯æŒçš„æ ˆç¡®å®æ˜¯â€œå‘ä¸‹å¢é•¿â€çš„ï¼špushæŒ‡ä»¤å¯¼è‡´spè‡ªå‡ä¸€ä¸ªslotï¼ŒpopæŒ‡ä»¤å¯¼è‡´spè‡ªå¢ä¸€ä¸ªslotã€‚å…¶å®ƒç¡¬ä»¶æœ‰å…¶å®ƒç¡¬ä»¶çš„æƒ…å†µã€‚

### æ ˆçš„å¢é•¿æ–¹å‘ä¸æ ˆå¸§å¸ƒå±€
---
è¿™ä¸ªä¸Šä¸‹æ–‡é‡Œè¯´çš„â€œæ ˆâ€æ˜¯**å‡½æ•°è°ƒç”¨æ ˆ**ï¼Œæ˜¯ä»¥â€œæ ˆå¸§â€ï¼ˆstack frameï¼‰ä¸ºå•ä½çš„ã€‚

æ¯ä¸€æ¬¡å‡½æ•°è°ƒç”¨ä¼šåœ¨æ ˆä¸Šåˆ†é…ä¸€ä¸ªæ–°çš„æ ˆå¸§ï¼Œåœ¨è¿™æ¬¡å‡½æ•°è°ƒç”¨ç»“æŸæ—¶é‡Šæ”¾å…¶ç©ºé—´ã€‚

**è¢«è°ƒç”¨å‡½æ•°ï¼ˆcalleeï¼‰çš„æ ˆå¸§ç›¸å¯¹è°ƒç”¨å‡½æ•°ï¼ˆcallerï¼‰çš„æ ˆå¸§çš„ä½ç½®åæ˜ äº†æ ˆçš„å¢é•¿æ–¹å‘**ï¼šå¦‚æœè¢«è°ƒç”¨å‡½æ•°çš„æ ˆå¸§æ¯”è°ƒç”¨å‡½æ•°çš„åœ¨æ›´ä½çš„åœ°å€ï¼Œé‚£ä¹ˆæ ˆå°±æ˜¯å‘ä¸‹å¢é•¿ï¼›åä¹‹åˆ™æ˜¯å‘ä¸Šå¢é•¿ã€‚

è€Œåœ¨ä¸€ä¸ªæ ˆå¸§å†…ï¼Œå±€éƒ¨å˜é‡æ˜¯å¦‚ä½•åˆ†å¸ƒåˆ°æ ˆå¸§é‡Œçš„ï¼ˆæ‰€è°“æ ˆå¸§å¸ƒå±€ï¼Œstack frame layoutï¼‰ï¼Œ**è¿™å®Œå…¨æ˜¯ç¼–è¯‘å™¨çš„è‡ªç”±ã€‚**

The C standard does not dictate any layout for the other automatic variables. It specifically says, however, for the avoidance of doubt, that

The ordering of local variables on the stack is entirely implementation dependent and need not appear consistent.

```
[...] The layout of the storage for [function] parameters is unspecified. [(C11 6.9.1p9)](http://port70.net/~nsz/c/c11/n1570.html#6.9.1p9)
```


å¯ä»¥é€šè¿‡ä¸‹é¢çš„ç¨‹åºæ¥æŸ¥çœ‹ æ ˆçš„å¢é•¿æ–¹å‘å’Œæ ˆä¸Šå˜é‡çš„åœ°å€åˆ†å¸ƒï¼š

```cpp
#include <iostream>

struct BlkTest{
    int size;
    char test[0x10];
};

void testFunc(char* ptr){
  long long test1 = 0x01;
  long long test2 = 0x02;
  {
    BlkTest blkTest;
    BlkTest blkTest2;
    std::cout << "blkTest address: " << &blkTest << std::endl;
    std::cout << "blkTest address: " << &blkTest2 << std::endl;
  }


  std::cout << "test1   address: " << &test1 << std::endl;
  std::cout << "test2   address: " << &test2 << std::endl;
  std::cout << "ptr     address: " << &ptr << std::endl;
//   std::cout << "blkTest address: " << &blkTest << std::endl;
  std::cout << "diff test1 and test2: " << &test1 - &test2 << std::endl;
//   std::cout << "diff test1 and ptr: " << &test2 - (long long)&ptr << std::endl;
}

void testFunc2(){
  int test1 = 0x01;
  int test2 = 0x02;
  void* ptr = NULL;

  std::cout << "test1   address: " << &test1 << std::endl;
  std::cout << "test2   address: " << &test2 << std::endl;
  std::cout << "ptr     address: " << &ptr << std::endl;
  std::cout << "diff test1 and test2: " << &test1 - &test2 << std::endl;
}

void recursiveFunction(int depth) {
    int localVar = 0; // å±€éƒ¨å˜é‡
    // int localVar2 = 0; // å±€éƒ¨å˜é‡
    // void* ptr = NULL;

    if (depth > 0) {
        std::cout << "Address of Depth: " << &depth << std::endl;
        std::cout << "Address of the local variable: " << &localVar << std::endl;
        // std::cout << "Address of the second local variable: " << &localVar2 << std::endl;
        // std::cout << "Address of the pointer: " << &ptr << std::endl;
        recursiveFunction(depth - 1);
    }
}

int main() {
    // testFunc(NULL);
    testFunc2();
    // recursiveFunction(3); // è°ƒç”¨é€’å½’å‡½æ•°ï¼Œè§‚å¯Ÿå±€éƒ¨å˜é‡çš„åœ°å€å˜åŒ–
    return 0;
}
```

åœ¨ç®€åŒ–çš„32ä½Linux/x86è¿›ç¨‹åœ°å€ç©ºé—´æ¨¡å‹é‡Œï¼Œï¼ˆä¸»çº¿ç¨‹çš„ï¼‰æ ˆç©ºé—´ç¡®å®æ¯”å †ç©ºé—´çš„åœ°å€è¦é«˜â€”â€”å®ƒå·²ç»å æ®äº†ç”¨æˆ·æ€åœ°å€ç©ºé—´çš„æœ€é«˜å¯åˆ†é…çš„åŒºåŸŸï¼Œå¹¶ä¸”å‘ä¸‹ï¼ˆå‘ä½åœ°å€ï¼‰å¢é•¿ã€‚å€Ÿç”¨Gustavo Duarteçš„

[Anatomy of a Program in Memory](https://link.zhihu.com/?target=http%3A//duartes.org/gustavo/blog/post/anatomy-of-a-program-in-memory/)

![[linux_memory.png]]

- è™½ç„¶ä¼ ç»Ÿä¸ŠLinuxä¸Šçš„[malloc](https://www.zhihu.com/search?q=malloc&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22%3A%22answer%22%2C%22sourceId%22%3A66101372%7D)å®ç°ä¼šä½¿ç”¨**brk()/sbrk()æ¥å®ç°malloc()**ï¼ˆè¿™ä¿©æ„æˆäº†ä¸Šå›¾ä¸­â€œHeapâ€æ‰€ç¤ºçš„éƒ¨åˆ†ï¼Œè¿™ä¹Ÿæ˜¯Linuxè‡ªèº«æ‰€è®¤ä¸ºæ˜¯heapçš„åœ°æ–¹â€”â€”ç”¨[pmap](https://www.zhihu.com/search?q=pmap&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22%3A%22answer%22%2C%22sourceId%22%3A66101372%7D)çœ‹å¯ä»¥çœ‹åˆ°è¿™é‡Œè¢«æ ‡è®°ä¸º[heap]ï¼‰ï¼Œä½†è¿™å¹¶ä¸æ˜¯å¿…é¡»çš„â€”â€”**ä¸€ä¸ªmalloc()å®ç°å®Œå…¨å¯ä»¥åªç”¨æˆ–åŸºæœ¬ä¸Šåªç”¨mmap()æ¥å®ç°malloc()**ï¼Œæ­¤æ—¶ä¸€èˆ¬è¯´çš„â€œHeapâ€ï¼ˆ[malloc-heap](https://www.zhihu.com/search?q=malloc-heap&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22%3A%22answer%22%2C%22sourceId%22%3A66101372%7D)ï¼‰å°±ä¸ä¸€å®šåœ¨ä¸Šå›¾â€œHeapâ€ï¼ˆLinux heapï¼‰æ‰€ç¤ºéƒ¨åˆ†ï¼Œè€Œä¼šåœ¨â€œMemory Mapping Segmentâ€éƒ¨åˆ†æ•£å¸ƒå¼€æ¥ã€‚ä¸åŒç‰ˆæœ¬çš„Linuxåœ¨åˆ†é…æœªæŒ‡å®šèµ·å§‹åœ°å€çš„mmap()æ—¶ç”¨çš„é¡ºåºä¸ä¸€æ ·ï¼Œå¹¶ä¸ä¿è¯æŸç§é¡ºåºã€‚è€Œä¸”mmap()åˆ†é…åˆ°çš„ç©ºé—´æ˜¯æœ‰å¯èƒ½å‡ºç°åœ¨ä½äºä¸»[å¯æ‰§è¡Œç¨‹åº](https://www.zhihu.com/search?q=%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22%3A%22answer%22%2C%22sourceId%22%3A66101372%7D)æ˜ å°„è¿›æ¥çš„text Segmentæ‰€åœ¨çš„ä½ç½®ã€‚  
    
- Linuxä¸Š[å¤šçº¿ç¨‹è¿›ç¨‹](https://www.zhihu.com/search?q=%E5%A4%9A%E7%BA%BF%E7%A8%8B%E8%BF%9B%E7%A8%8B&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22%3A%22answer%22%2C%22sourceId%22%3A66101372%7D)ä¸­ï¼Œâ€œçº¿ç¨‹â€å…¶å®æ˜¯ä¸€ç»„å…±äº«[è™šæ‹Ÿåœ°å€ç©ºé—´](https://www.zhihu.com/search?q=%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22%3A%22answer%22%2C%22sourceId%22%3A66101372%7D)çš„è¿›ç¨‹ã€‚**åªæœ‰ä¸»çº¿ç¨‹çš„æ ˆæ˜¯æŒ‰ç…§ä¸Šé¢å›¾ç¤ºåˆ†å¸ƒ**ï¼Œå…¶å®ƒçº¿ç¨‹çš„æ ˆçš„ä½ç½®å…¶å®æ˜¯â€œéšæœºâ€çš„â€”â€”å®ƒä»¬å¯ä»¥ç”±pthread_create()è°ƒç”¨mmap()æ¥åˆ†é…ï¼Œä¹Ÿå¯ä»¥ç”±ç¨‹åºè‡ªå·±è°ƒç”¨mmap()ä¹‹åæŠŠåœ°å€ä¼ ç»™[pthread_create](https://www.zhihu.com/search?q=pthread_create&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22%3A%22answer%22%2C%22sourceId%22%3A66101372%7D)()ã€‚æ—¢ç„¶æ˜¯mmap()æ¥çš„ï¼Œ**å…¶å®ƒ[çº¿ç¨‹](https://www.zhihu.com/search?q=%E7%BA%BF%E7%A8%8B&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22%3A%22answer%22%2C%22sourceId%22%3A66101372%7D)çš„æ ˆå‡ºç°åœ¨Memory Mapping Segmentçš„ä»»æ„ä½ç½®éƒ½ä¸å‡ºå¥‡**ï¼Œä¸ç”¨äºå®ç°malloc()ç”¨çš„mmap()ç©ºé—´å¾ˆå¯èƒ½æ˜¯äº¤é”™å‡ºç°çš„ã€‚


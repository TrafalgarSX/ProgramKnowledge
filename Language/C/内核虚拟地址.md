Windowså’ŒLinuxä¸‹çš„è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€éƒ½åŒ…å«å†…æ ¸è™šæ‹Ÿåœ°å€ï¼Œ ä½†å®é™…ä¸Šæ‰€æœ‰è¿›ç¨‹çš„è¿™ä¸€éƒ¨åˆ†éƒ½æ˜ å°„ç€ç›¸åŒçš„ç‰©ç†å†…å­˜ï¼Œ é‚£ä¸ºä»€ä¹ˆè¿˜è¦æ¯ä¸ªè¿›ç¨‹éƒ½è¦åŒ…å«ç›¸åŒçš„å†…æ ¸è™šæ‹Ÿåœ°å€å‘¢ï¼Ÿ

stack overflowä¸Šä¸æˆ‘æœ‰ç›¸åŒçš„ç–‘é—®çš„ã€‚
[memory management - Why is kernel said to be in process address space? - Stack Overflow](https://stackoverflow.com/questions/7275689/why-is-kernel-said-to-be-in-process-address-space)

[linux - Why is kernel mapped to the same address space as processes? - Stack Overflow](https://stackoverflow.com/questions/13013491/why-is-kernel-mapped-to-the-same-address-space-as-processes)


When the process makes a system call, **we don't need to switch the page tables (from process address space page table to kernel address space page table) for servicing the system call (which should be done only in kernel mode).** 

ğŸ’¡This is said to be that the kernel is **running in the process context**.

å¥½å¤„ï¼š

1. The operating system uses its portion by mapping the kernel into the address space of each process, which **avoids the overhead of switching address spaces when the kernel needs to access a user virtual address space**. However, there still needs to be a change in the privilege level.

2. This reduces the size of the available virtual address space for both the kernel and user. **The benefit is that user virtual addresses can be directly accessed in the kernel**. An operation such as a copyout() or copyin() can be implemented as a simple memory copy (although with a page-faulting caveat).

3. On most modern hardware, it is quicker to change the security level (thus allowing access to the pages that are otherwise protected, as mentioned in Alexey's answer) in order to perform system calls and other kernel provided functions than it is to change the security level and the entire virtual memory map, along with all the associated TLB cache flushes and everything else involved in a full context switch.


â—TLB (Transition Lookaside Buffer) would get reset for every page-table switch, and that's a lot of waste time.

TLBåœ¨åˆ‡æ¢é¡µè¡¨çš„æ—¶å€™ä¼šåˆ·æ–°

å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œ å³å‡å°‘é¡µè¡¨ç­‰çš„åˆ‡æ¢ã€‚


macos ä¸åŒ

[Section 8.8. Kernel and User Address Space Layouts | Mac OS X Internals: A Systems Approach](https://flylib.com/books/en/3.126.1.91/1/)


Mac OS X **does not map the kernel into each user address space**, and therefore each user/kernel transition (in either direction) requires an address space switch

To sum up, **the kernel does not take any part of a process's address space.** The kernel and every user process get the full 4GB (32-bit) address space. Each transition from user to kernel (and back) requires an address space switch.

### å†…æ ¸è™šæ‹Ÿåœ°å€å¦‚ä½•æ˜ å°„
1. å†…æ ¸ç©ºé—´ï¼Œç”¨æˆ·ç©ºé—´çš„åœ°å€éƒ½æ˜¯è™šæ‹Ÿåœ°å€ï¼Œéƒ½è¦ç»è¿‡ MMU çš„ç¿»è¯‘ï¼Œå˜æˆç‰©ç†åœ°å€. ç½—å—¦ä¸€ä¸‹, æ˜ç™½è¿™ç‚¹å¾ˆé‡è¦, ä»CPUè§’åº¦çœ‹, æ‰€è°“å†…æ ¸ç©ºé—´åœ°å€/ç”¨æˆ·ç©ºé—´åœ°å€, åªæ˜¯æƒé™ä¸ä¸€æ ·è€Œå·², è¦è·å–å®ƒä»¬çš„ç‰©ç†åœ°å€, ä»**ç¡¬ä»¶å±‚é¢**ä¸Š, éƒ½è¦èµ°MMUè¿™å¥—ç¡¬ä»¶æœºåˆ¶ã€‚ ä½†æ˜¯, **è½¯ä»¶å±‚é¢,** å¯å°±ä¸ä¸€å®šäº†. å½“éœ€è¦çŸ¥é“ä¸€ä¸ªç”¨æˆ·ç©ºé—´è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç‰©ç†åœ°å€ï¼Œå°±æ˜¯ç¼–ç æ¨¡æ‹Ÿä¸Šè¿°çš„èµ°å››çº§é¡µè¡¨è¿‡ç¨‹, æ¥ç¿»è¯‘å¾—åˆ°å®ƒçš„ç‰©ç†åœ°å€ã€‚ ä½†æ˜¯, **å†…æ ¸ç©ºé—´è™šæ‹Ÿåœ°å€æ˜¯æ‰€æœ‰è¿›ç¨‹å…±äº«çš„ï¼Œè€Œä¸”æ•ˆç‡å¾ˆé‡è¦, è¿™å°±æœ‰å–å·§ä¼˜åŒ–çš„ç©ºé—´äº†: å†…æ ¸åœ¨åˆå§‹åŒ–æ—¶ï¼Œå°±åˆ›å»ºå†…æ ¸ç©ºé—´çš„æ˜ å°„ï¼ˆå› ä¸ºæ‰€æœ‰è¿›ç¨‹å…±äº«ï¼Œæœ‰ä¸€ä»½å°±å¤Ÿäº†)ï¼Œå¹¶ä¸”ï¼Œé‡‡ç”¨çš„å°±æ˜¯çº¿æ€§æ˜ å°„ï¼Œæ‰€è°“çº¿æ€§, å°±æ˜¯å†…æ ¸ä¸€æ•´å—å†…æ ¸ç©ºé—´é¡µ, ä¸€å¯¹ä¸€åœ°æ˜ å°„åˆ°ä¸€å—ç‰©ç†å†…å­˜ä¸Š**. è¿™æ„å‘³ç€, åœ¨è½¯ä»¶å±‚é¢(å†…æ ¸), å½“å†…æ ¸éœ€è¦çŸ¥é“å®ƒè®¿é—®çš„ä¸€ä¸ªå†…æ ¸ç©ºé—´é¡µé¢Pxçš„ç‰©ç†åœ°å€æ—¶, å®ƒåªè¦çŸ¥é“ç¬¬ä¸€é¡µP0çš„ç‰©ç†åœ°å€å³å¯, ç„¶ååŠ ä¸ŠPxç›¸è·P0çš„åç§», å³å¯å¿«é€ŸçŸ¥é“Pxçš„ç‰©ç†åœ°å€(çº¿æ€§æ˜ å°„çš„ä¼˜åŠ¿), è€Œä¸éœ€è¦èµ°é¡µè¡¨ç¿»è¯‘è¿™ç§ç±»ä¼¼å“ˆå¸Œè¡¨çš„æ–¹å¼å»è®¡ç®—(**å½“ç„¶, è®°ä½, å½“å†…æ ¸å»è®¿é—®è¯¥é¡µæ—¶, ç¡¬ä»¶å±‚é¢ä»ç„¶èµ°çš„æ˜¯MMUç¿»è¯‘çš„å…¨è¿‡ç¨‹**)ã€‚ä¸è¿‡ï¼Œå†…æ ¸ç©ºé—´å¹¶éå®Œå…¨ä¸ç”¨é¡µè¡¨ï¼Œæ­¤å¤„è®²åŸç†æ‰€ä»¥ç®€åŒ–ï¼Œè¯¦ç»†çš„çœ‹å°¾æ³¨.

2. è‡³äºä¸ºä»€ä¹ˆç”¨æˆ·ç©ºé—´ä¸èƒ½ä¹Ÿåƒå†…æ ¸ç©ºé—´è¿™ä¹ˆåšï¼ŒåŸå› æ˜¯ç”¨æˆ·åœ°å€ç©ºé—´æ˜¯éšè¿›ç¨‹åˆ›å»ºæ‰äº§ç”Ÿçš„ï¼Œæ— æ³•äº‹å…ˆç»™å®ƒåˆ†é…ä¸€å—è¿ç»­çš„å†…å­˜: å®ƒçš„é¡µé¢å¯èƒ½æ•£å¸ƒåœ¨ä¸åŒçš„ç‰©ç†å†…å­˜ä¸­(ä¸æ˜¯çº¿æ€§çš„äº†)ï¼Œæ— æ³•è¿™ä¹ˆåšã€‚è€Œå†…æ ¸ç©ºé—´ï¼Œåªæœ‰ä¸€ä»½ï¼Œæ‰€æœ‰å¯ä»¥æå‰å›ºå®šä¸‹æ¥ä¸€ç‰‡è¿ç»­çš„ç‰©ç†åœ°å€ç©ºé—´ï¼ŒæŒ‰çº¿æ€§æ–¹æ³•æ¥æ˜ å°„ã€‚è¿™æ˜¯å¾ˆæ­£å¸¸çš„ä¼˜åŒ–æ–¹æ³•, 3ä¸­å·²ç»è®²è¿°è¿‡åŸç†ã€‚

3. é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œåœ¨ Linux åˆšå¼•å…¥çš„æ—¶å€™ï¼Œ i386 4G çš„è¿›ç¨‹ç©ºé—´å…¸å‹çš„æ˜¯ 3G user + 1G kernel çš„åˆ’åˆ†ï¼Œè¿™æ•™ç§‘ä¹¦ä¸Šéƒ½æœ‰è¯´ã€‚ é‚£æŒ‰å‰é¢çš„çº¿æ€§æ–¹æ³•ï¼Œ 1G å†…æ ¸ç©ºé—´ï¼Œåªèƒ½æ˜ å°„ 1G ç‰©ç†åœ°å€ç©ºé—´ï¼Œè¿™å¯¹å†…æ ¸æ¥è¯´ï¼Œå¤ªæ£è‚˜äº†ã€‚æ‰€ä»¥ï¼Œ**æŠ˜è¡·æ–¹æ¡ˆæ˜¯ï¼Œ Linux å†…æ ¸åªå¯¹ 1G å†…æ ¸ç©ºé—´çš„å‰ 896 MB æŒ‰å‰é¢æ‰€è¯´çš„æ–¹æ³•çº¿æ€§æ˜ å°„, å‰©ä¸‹çš„ 128 MB çš„å†…æ ¸ç©ºé—´ï¼Œ é‡‡ç”¨åŠ¨æ€æ˜ å°„[1]çš„æ–¹å¼ï¼Œå³æŒ‰éœ€æ˜ å°„çš„æ–¹å¼ ï¼Œè¿™æ ·ï¼Œå†…æ ¸æ€çš„è®¿é—®ç©ºé—´æ›´å¤šäº†**ã€‚ è¿™ä¸ªç›´æ¥æ˜ å°„çš„éƒ¨åˆ†ï¼Œ å°±æ˜¯é¢˜ä¸»æ‰€è¯´çš„ **NORMAL åŒºï¼Œ å°±æ˜¯æ‰€è°“ä½ç«¯å†…å­˜**ã€‚åˆ°äº† 64 ä½æ—¶ä»£ï¼Œ å†…æ ¸ç©ºé—´å¤§å¤§å¢å¤§ï¼Œ è¿™ç§é™åˆ¶å°±æ²¡äº†ï¼Œå†…æ ¸ç©ºé—´å¯ä»¥å®Œå…¨è¿›è¡Œçº¿æ€§æ˜ å°„ï¼Œä¸è¿‡ï¼ŒåŸºäº[1]çš„ç¼˜æ•…ï¼Œ ä»ä¿ç•™æœ‰åŠ¨æ€æ˜ å°„è¿™éƒ¨åˆ†ã€‚

  

[1] åŠ¨æ€æ˜ å°„ä¸å…¨æ˜¯ä¸ºäº†å†…æ ¸ç©ºé—´å¯ä»¥è®¿é—®æ›´å¤šçš„ç‰©ç†å†…å­˜ï¼Œè¿˜æœ‰ä¸€ä¸ªé‡è¦åŸå› ï¼š å½“å†…æ ¸éœ€è¦è¿ç»­å¤šé¡µé¢çš„ç©ºé—´æ—¶ï¼Œå¦‚æœå†…æ ¸ç©ºé—´å…¨çº¿æ€§æ˜ å°„ï¼Œé‚£ä¹ˆï¼Œå¯èƒ½ä¼šå‡ºç°å†…æ ¸ç©ºé—´ç¢ç‰‡åŒ–è€Œæ»¡è¶³ä¸äº†è¿™ä¹ˆå¤šè¿ç»­é¡µé¢åˆ†é…çš„éœ€æ±‚ã€‚åŸºäºæ­¤ï¼Œå†…æ ¸ç©ºé—´ä¹Ÿå¿…é¡»æœ‰ä¸€éƒ¨åˆ†æ˜¯éçº¿æ€§æ˜ å°„ï¼Œä»è€Œåœ¨è¿™ç¢ç‰‡åŒ–ç‰©ç†åœ°å€ç©ºé—´ä¸Šï¼Œç”¨é¡µè¡¨æ„é€ è¿ç»­è™šæ‹Ÿåœ°å€ç©ºé—´,è¿™å°±æ˜¯æ‰€è°“vmallocç©ºé—´ã€‚

[è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€å’Œå†…æ ¸ä¸­çš„è™šæ‹Ÿåœ°å€æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ - çŸ¥ä¹](https://www.zhihu.com/question/34787574)


### 前言
---
调试功能做为开发的必备神技，熟练掌握后能极大的提高开发效率，再也不必为频繁运行代码而苦恼了。文章同时还会详细介绍调试的原理以及一些调试过程中的常见问题，想知道为什么方法断点那么慢？

### 运行调试
---
开启Debug调试模式有两种方式
![[startDebug.png]]

Debug Run: 直接以Debug模式运行APP， 该模式的优点时可以调试程序启动相关的代码，例如`Application.onCreate()`。

Attach To Process: 在程序运行中选择进程来调试， 该模式的优点是随时可以开启、关闭Debug模式， 使用灵活方便。❓

注意：Debug Run 会导致程序整体变慢，建议使用等待调试，使用该方式可以在启动应用后处于**等待状态**，在开启调试后，应用才会走初始化流程，有两种方式开启等待断点：

方法1：「开发者选项 - 选择调试应用」的方式来调试应用启动阶段代码。具体方式为「选择调试应用」-> 「运行应用」-> 「Attach To Process」，然后等待断点执行即可。
方法2：使用adb命令`adb shell am set-debug-app -w --persistent 包名`开启，「-w」即表示应用启动时等待调试程序；关闭使用`adb shell am clear-debug-app`。
❓  有时间尝试一下上面的方式

### 调试操作
---
1. Show Execution Point：跳到当前执行的断点处。
2. Step Over：单步执行，执行到当前行的下一行。
3. Step Into：进入正在执行的方法。
4. Focus Step Into：同3，但是可以进入源码，在3无法进入的情况下，可以尝试该操作。
5. Step Out：跳出正在执行的方法。
6. Drop Frame：返回到当前方法的调用处。
7. Run to Cursor：运行到光标处（光标必须在当前断点位置后）。
8. Evaluate expression：计算选中的变量的值。
![[DebugMotion.png]]

### 断点类型
---
断点分为以下四种类型：  
**行断点**： 当执行到此行是停止执行，等待调试。（最常用）  
**属性断点**：打在类的成员变量上，当变量初始化或变量的值改变时触发断点。
**异常断点**：当抛出指定异常时触发断点。  
**方法断点**：当需要知道一个方法的调用方时。

💡还是要使用一下其他断点，怎么方便怎么来

这里着重讲一下方法断点的使用场景：  
如下所示，有个接口 `IMethodTest`，同时有两个类 `MethodTestImpl1` 和 `MethodTestImpl2` 实现了该接口，在 `IMethodTest` 的 `printMethod()` 上打上方法断点。

在代码中实例化了 `MethodTestImpl2` 来调用 `printMethod()` 。

最后当 Debug 到该方法断点时，会自动走到 `MethodTestImpl2` 的 `printMethod()` 的实现中。

注：方法断点只支持 Java 代码。

### 调试实战
---
大家都知道调试是提高开发效率的利器，那么它是如何帮助开发者的呢？  
答案就是「**查看信息**」和「**减少编译次数**」。

#### 查看信息
当程序运行结果并不如你的预期时，通过调试来查看当前内存里的变量以及堆栈信息，是最快速定位问题的方式。

**查看局部变量**的方式如下图所示

- 系统自动打印：在当前调试位置之前的代码右侧会自动打印当前栈帧里保存的变量值。  
- 鼠标悬停：鼠标悬停在一个变量上几秒后，会列出该变量的详细信息。  
- Variables 区：在 Variables 区里会自动打印当前方法里的变量详细信息。

**查看全局变量**有两种方式

![查看全局变量](https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/23609143235/6399/52f0/91be/f421a239680cb79b4072953e4c220b69.png)

- 在 Variables 区添加监听：点击左侧操作栏里的「+」，输入对应变量值，即可实时观察该值的变化。
- 在 Evaluate Expression 中输入想要观察的变量，回车后即可查看当前时刻该变量的值。

**注：查看局部变量和全局变量需要断点位置能访问到该值。**

#### 查看堆栈信息
在调试页面的「Debugger」Tab下可以查看当前的调用堆栈。

需要注意的是，一个线程只会被一个断点阻塞，但是不同线程是可以同时阻塞的，可以切换下拉框来切换线程，**红色圆点表示正在被阻塞的线程**。

![线程](https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/23609143234/8fd9/2bd4/1095/6b254312e1fef6529b46e9222c7c41da.png)

### 减少编译次数
---
越大的项目运行起来越是缓慢，而有时我们只是修改了一行代码甚至是一个字符，这时再去重新编译是效率非常低下的，而灵活运用各种调试技巧，就可以帮助我们在不重新运行项目的前提下，去修改运行中代码。

![[减少编译次数.png]]

#### 运行期代码植入
想修改已经运行起来的代码，有两种方式：

- 在 Variables 区中使用 setValue。

- 使用 Evaluate Expression。

Evaluate Expression 是一个非常强大的功能，可以展开执行任意的代码段。灵活运用可以大量的减少编译次数，例如：

- 修改网络请求、外部跳转等来源的数据，模拟各种场景。
- 执行某些代码，直接查看结果。
- 执行某一段异常代码，直接查看报错信息。

#### 日志断点
日志是辅助开发排查问题的常见手段，但是在代码中添加日志存在一些不便的情况，例如：

- 需要重新运行程序。
- 开发完成之后需要去除对应的日志代码。  
    **而使用日志断点就可以避免以上问题，使用方式为在断点位置右键，取消 Suspend 框的勾选，同时勾选 Evaluate and Log 并输入想要的内容。**


#### 条件断点
**当一个断点会被多次执行，而调试时只需求在某些特定条件下才挂起，可以使用条件断点。** 使用方式为在断点位置右键，在 Condition 框中输入条件表达式，回车，这时断点右下角出现一个「？」即为条件断点成功挂载。  
注意，条件断点的表达式返回值必须为 true 或者 false，否则断点报错。

#### 异常断点
当开发者知道接下来一定会报某一个异常，但是又不知道会是哪段代码触发时，可以尝试使用异常断点。使用方式为在断点管理界面点击「+」，添加 Java Exception Breakpoints。

然后输入你想要捕获的异常，注意，这里也会捕获系统抛出的异常，捕获时请仔细观察。

#### 多线程断点
多线程是日常开发中常见的问题，针对一系列线程切换场景，调试工具也有对应的方式来辅助我们定位问题。

在 CPU 的时间片执行机制下，如果不加以控制，开发者是无法预估线程执行顺序的。而直接写一系列的线程控制代码耗时不小，**有没有办法能先让线程按照开发者想要的顺序去执行呢？** 请继续往下看：

在断点位置上右键，出来的管理界面里有 All 和 Thread 两个选项：

- All 表示阻塞所有线程，**即所有线程都走到当前断点位置后**，才能继续往下走。
- Thread 表示阻塞当前线程，**即当前线程的代码走完后**，才会走其他线程。

### 调试Release包
---
调试Relase包偏Android逆向，由于篇幅有限，这里主要介绍和调试相关内容，前期准备可以看这里[DebugApkSmali](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhi-dhl%2FDebugApkSmali "https://github.com/hi-dhl/DebugApkSmali")。

在反编译 APK，Smali 文件生成后，我们需要把手机和 Android Studio 关联上，这里需要使用 Remote 功能，具体流程如下：

选择 Edit Configurations。

新增 Remote JVM Debug，Name 随意，Port 不与现有端口冲突即可。

[Android 调试实战与原理详解 - 掘金](https://juejin.cn/post/7194630163924484155)

### ADB架构
---
![[ADB架构.png]]

### JDWP协议
---
在了解了 ADB 协议后，我们知道了命令是如何从 Android Studio 或者命令行传输到手机上的 ADB Dameon 的，那么 ADB Dameon 又是如何与虚拟机交互的，以及传输协议中的数据格式又是怎样的呢，这里就需要理解 JDWP 协议了。

JDWP 是 Java Debug Wire Protocol 的缩写，其本质上是调试器和目标虚拟机进行调试交互的通信协议，通过命令包和回复包两种格式来传输数据。  
这里有四个概念需要了解：

- 调试器（Debugger）：Android Studio、Eclipse、DDMS、Terminal 等，他们都实现了支持 JDWP 通信接口。
- 目标虚拟机（Target VM）：JVM、Art、Dalvik 等，在虚拟机启动时，会加载JDWP模块。
- 命令包（Command packet）：调试器发送给虚拟机用于获取程序状态信息或控制程序运行，或者虚拟机发送给调试器用于通知事件触发消息。
- 回复包（Reply packet）：虚拟机发送给调试器用于回复命令包的请求或者执行结果。
![[JWDP交互.png]]

### 常见问题
---
在讲完了调试实战和原理之后，我们来看一些常见的调试问题：

- 断点主动断开  
    现象：在某些机型上，例如华为非鸿蒙系统、部分 OPPO、一加设备等，当断点在 Activity、Fragment 的生命周期方法上超过10秒或者卡住页面展示超过一定时间（不同设备时长不一致）时，会出现断点主动断开的情况。  
    解决方式：使用非阻塞式的日志断点。
    
- 无法Attach to Process  
    现象：在挂载进程进行调试时，出现 `Error running 'Android Debugger (-1)': Invalid argument : Argument invalid [port]` 的报错，这时是由于 adb 进程端口号被其他进程抢占了。  
    解决方式：使用 `adb kill-server` 杀死 adb 进程，然后使用任意一个 adb 命令（adb devices）fork 一个新的 adb 进程即可。
    
- 方法断点导致Debug卡顿  
    现象：在使用方法断点时，调试器会变得异常卡顿，这是因为方法断点需要跟踪方法的入栈和出栈，每次进出都要发送指令给调试，具体流程如下：  
    1.把方法断点加入断点列表。  
    2.调试器发送指令告诉虚拟机需要监听 Method Entry 和 Method Exit。  
    3.虚拟机每次收到 Method Entry 或者 Method Exit 后发送事件给调试器。  
    4.调试器判断是否在断点列表中。  
    5.存在则向虚拟机发送 SetBreakPoint 请求挂起，否则发送请求释放该方法栈。  
    解决方式：  
    1.根据实际情况放开 Method Entry 或者 Method Exit，如下图所示。  
    2.用完即弃，及时去除方法断点。  
    3.不要用！使用行断点（官方建议）。